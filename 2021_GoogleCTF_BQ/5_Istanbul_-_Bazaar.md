# Istanbul - Bazaar
Category: Misc.

## Description

> It’s a hot day, and your skin is cracking and dry. It’s difficult to make your way through the crowded bazaar. A high pitch voice pierces through the soundscape from a salesman that’s trying to sell colorful fabrics and then from another corner comes delicious smells. You spot a hand waving - it’s your contact that you’ve been waiting to meet. "Take a seat, my friend, I’m Gökhan, have you been to Istanbul before? No, really? I’m sure that you will have a great time, I’ve ordered tea for the two of us. Show me the amulet, will you?. Wow, this is really something from my younger days, this is as mysterious as it is beautiful and belongs to “The cloaked brotherhood”. They are very dangerous, and eventhough your quest is urgent, I would advise you to not continue looking for the owner of this. Go home, and forget about it." In the blink of an eye, four tough guys show up, and you start to run together with Gökhan through the crowded marketplace and then up on a rooftop. The tough guys are closing in, but the two of you climb down from the rooftop, run around a corner and are able to hide in two crates.
> 
> Challenge: Twisted robot (misc)
> 
> We found this old robo caller. It basically generates random phone numbers to spam. We found the last list of numbers in generated and also some weird file... Maybe it's got to do with these new beta features they were testing?

Three files were attached: `robo_numbers_list.txt`, `RoboCaller1337.py` and `secret.enc`.

## Solution

Let's check the attached files.

The Python script:

```python
import random

# Gots to get that formatting right when send it to our call center
def formatNumber(n):
    n = str(n)
    return f'{n[:3]}-{n[3:6]}-{n[6:]}'

# This generates random phone numbers because it's easy to find a lot of people!
# Our number generator is not great so we had to hack it a bit to make sure we can
# reach folks in Philly (area code 215)
def generateRandomNumbers():
    arr = []
    for i in range(624):
        arr.append(formatNumber(random.getrandbits(32) + (1<<31)))
    return arr

def encodeSecret(s):
    key = [random.getrandbits(8) for i in range(len(s))]
    return bytes([a^b for a,b in zip(key,list(s.encode()))])


def menu():
    print("""\n\nWelcome to the RoboCaller!! What would you like to do?
1: generate a new list of numbers
2: encrypt a super secret (in beta)
3: decrypt a super secret (coming soon!!)
4: exit""")
    choice = ''
    while choice not in ['1','2','3']:
        choice = input('>')
        if choice == '1':
            open('robo_numbers_list.txt','w').write('\n'.join(generateRandomNumbers()))
            print("...done! list saved under 'robo_numbers_list.txt'")
        elif choice == '2':
            secret = input('give me your secret and I\'ll save it as "secret.enc"')
            open('secret.enc','wb').write(encodeSecret(secret))
        elif choice == '3':
            print("stay tuned for this awesome feature\n\n")
        elif choice == '4':
            print("Thank you for using RoboCaller1337!")
    return

def main():
    while True:
        menu()

if __name__ == "__main__":
    main()

```

The binary file:

```console
┌──(user@kali)-[/media/sf_CTFs/google/5_Istanbul_-_Bazaar/download]
└─$ xxd -g 1 secret.enc
00000000: 95 47 08 58 19 2b f8 0c 2b 2a 55 11 29 e1 22 8f  .G.X.+..+*U.).".
00000010: ab 42 c9 0c 67 c5 df 44 e1 f3 e5 cb 3f 61 3c     .B..g..D....?a<
```

The text file: 

```
┌──(user@kali)-[/media/sf_CTFs/google/5_Istanbul_-_Bazaar/download]
└─$ wc -l robo_numbers_list.txt
623 robo_numbers_list.txt

┌──(user@kali)-[/media/sf_CTFs/google/5_Istanbul_-_Bazaar/download]
└─$ cat robo_numbers_list.txt| head
263-170-6234
467-553-7030
220-146-1293
630-328-6023
413-553-0465
528-403-6609
454-641-6157
396-906-1900
445-477-6643
578-095-2052
```

This file has 624 lines of random phone numbers, as generated by `generateRandomNumbers`. We know that these numbers were generated immediately before `encodeSecret` was called, how do we use this to recover the random values used for `encodeSecret`?

It turns out that Python uses the `Mersenne Twister` algorithm for its `random` module, and that it's possible to predict the MT19937 PRNG given preceding 624 generated numbers. [This library](https://github.com/kmyk/mersenne-twister-predictor) offers a simple way to predict the values, once fed `624` DWORDs of `random` output.

So, we just have to reverse the phone numbers into their original format as received by `random`, feed them into the predictor and then read the additional values from the predictor to XOR with the encrypted output:

```python
from mt19937predictor import MT19937Predictor

def formatNumber(n):
    n += (1<<31)
    n = str(n)
    return f'{n[:3]}-{n[3:6]}-{n[6:]}'

def deformatNumber(s):
    arr = list(map(int, s.split("-")))
    res  = arr[2]
    res += arr[1] * 10**4
    res += arr[0] * 10**7
    res -= (1<<31)
    return res


with open("download/robo_numbers_list.txt") as f, open("download/secret.enc", "rb") as s:
    predictor = MT19937Predictor()
    for line in f:
        line = line.rstrip()
        num = deformatNumber(line)
        predictor.setrandbits(num, 32)
    
    secret = s.read()
    for c in secret:
        print(chr(c ^ predictor.getrandbits(8)), end="")

    print("")
```

Output:

```console
┌──(user@kali)-[/media/sf_CTFs/google/5_Istanbul_-_Bazaar]
└─$ python3 solve.py
CTF{n3v3r_3ver_ev3r_use_r4nd0m}
```